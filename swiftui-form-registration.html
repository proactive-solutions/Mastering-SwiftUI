<!DOCTYPE HTML>
<html lang="zh-tw" >
    
    <head>
        
        <meta charset=utf-8"UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=11; IE=10; IE=9; IE=8; IE=7; IE=EDGE" />
        <title>以 Combine 与 视图模型建立一个注册表单 | 精通 SwiftUI - iOS 16 版</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.0.1">
        <meta name="author" content="Simon Ng">
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">
        
    
    
    <link rel="next" href="./swiftui-actionsheet-context.html" />
    
    
    <link rel="prev" href="./swiftui-form-data.html" />
    

        
    </head>
    <body>
        
        
    <link rel="stylesheet" href="gitbook/style.css">
    
        
        <link rel="stylesheet" href="gitbook/plugins/gitbook-plugin-image-captions/image-captions.css">
        
    
    
        <link rel="stylesheet" href="././styles/website.css">
    

        
    <div class="book" data-level="15" data-basepath="." data-revision="Thu Dec 01 2022 17:36:55 GMT+0800 (HKT)">
    

<div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="输入并搜寻" class="form-control" />
    </div>
    <ul class="summary">
        
        
        
            
            <li>
                <a href="https://www.appcoda.com.tw" target="blank" class="custom-link">Made by AppCoda</a>
            </li>
        
            
            <li>
                <a href="https://www.appcoda.com.tw/contact" target="blank" class="custom-link">Contact us / Support</a>
            </li>
        
            
            <li>
                <a href="http://twitter.com/share?text=Mastering%20SwiftUI%20via%20@appcodamobile&amp;url=https://www.appcoda.com.tw/swiftui/&amp;hashtags=swiftlang" target="blank" class="custom-link">Tweet this book</a>
            </li>
        
        

        
        <li class="divider"></li>
        

        
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="./index.html">
                        <i class="fa fa-check"></i>
                        
                        序言
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="1" data-path="swiftui-basics.html">
            
                
                    <a href="./swiftui-basics.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                        SwiftUI 介绍
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="2" data-path="swiftui-text.html">
            
                
                    <a href="./swiftui-text.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                        SwiftUI 入门 - 文字的处理
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="3" data-path="swiftui-images.html">
            
                
                    <a href="./swiftui-images.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                        图片的处理
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="4" data-path="swiftui-stacks.html">
            
                
                    <a href="./swiftui-stacks.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                        以堆叠布局使用者介面
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="5" data-path="swiftui-scrollview.html">
            
                
                    <a href="./swiftui-scrollview.html">
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                        ScrollView 与 Carousel UI 的建立
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="6" data-path="swiftui-buttons.html">
            
                
                    <a href="./swiftui-buttons.html">
                        <i class="fa fa-check"></i>
                        
                            <b>6.</b>
                        
                        SwiftUI 按钮与渐层
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="7" data-path="swiftui-state.html">
            
                
                    <a href="./swiftui-state.html">
                        <i class="fa fa-check"></i>
                        
                            <b>7.</b>
                        
                        状态(State)与绑定(Binding)
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="8" data-path="swiftui-path-shape.html">
            
                
                    <a href="./swiftui-path-shape.html">
                        <i class="fa fa-check"></i>
                        
                            <b>8.</b>
                        
                        实现路径(Path)与形状(Shape)来画线与圆饼图
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="9" data-path="swiftui-animation.html">
            
                
                    <a href="./swiftui-animation.html">
                        <i class="fa fa-check"></i>
                        
                            <b>9.</b>
                        
                        基础动画与转场
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="10" data-path="swiftui-list.html">
            
                
                    <a href="./swiftui-list.html">
                        <i class="fa fa-check"></i>
                        
                            <b>10.</b>
                        
                        动态列表、 ForEach 与 Identifiable 的使用方法
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="11" data-path="swiftui-navigation.html">
            
                
                    <a href="./swiftui-navigation.html">
                        <i class="fa fa-check"></i>
                        
                            <b>11.</b>
                        
                        导航UI与导航列客制化运用
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="12" data-path="swiftui-modal.html">
            
                
                    <a href="./swiftui-modal.html">
                        <i class="fa fa-check"></i>
                        
                            <b>12.</b>
                        
                        强制回应视图、浮动按钮与提示的实现
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="13" data-path="swiftui-form.html">
            
                
                    <a href="./swiftui-form.html">
                        <i class="fa fa-check"></i>
                        
                            <b>13.</b>
                        
                        以选取器(Picker)、开关(Toggle)与步进器(Stepper)来建立一个表单
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="14" data-path="swiftui-form-data.html">
            
                
                    <a href="./swiftui-form-data.html">
                        <i class="fa fa-check"></i>
                        
                            <b>14.</b>
                        
                        使用 Combine 与 Environment 物件进行数据分享
                    </a>
                
            
            
        </li>
    
        <li class="chapter active" data-level="15" data-path="swiftui-form-registration.html">
            
                
                    <a href="./swiftui-form-registration.html">
                        <i class="fa fa-check"></i>
                        
                            <b>15.</b>
                        
                        以 Combine 与 视图模型建立一个注册表单
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="16" data-path="swiftui-actionsheet-context.html">
            
                
                    <a href="./swiftui-actionsheet-context.html">
                        <i class="fa fa-check"></i>
                        
                            <b>16.</b>
                        
                        滑动删除、内容选单与动作列表
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="17" data-path="swiftui-gestures.html">
            
                
                    <a href="./swiftui-gestures.html">
                        <i class="fa fa-check"></i>
                        
                            <b>17.</b>
                        
                        认识手势（Gestures）
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="18" data-path="swiftui-bottom-sheet.html">
            
                
                    <a href="./swiftui-bottom-sheet.html">
                        <i class="fa fa-check"></i>
                        
                            <b>18.</b>
                        
                        以SwiftUI 手势与 GeometryReader 建立一个底部展开式页面
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="19" data-path="swiftui-trip-tinder.html">
            
                
                    <a href="./swiftui-trip-tinder.html">
                        <i class="fa fa-check"></i>
                        
                            <b>19.</b>
                        
                        使用手势与动画建立 Tinder 风格的 UI
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="20" data-path="swiftui-advanced-animations.html">
            
                
                    <a href="./swiftui-advanced-animations.html">
                        <i class="fa fa-check"></i>
                        
                            <b>20.</b>
                        
                        建立像 Apple Wallet App 的动画和转场效果
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="21" data-path="swiftui-json.html">
            
                
                    <a href="./swiftui-json.html">
                        <i class="fa fa-check"></i>
                        
                            <b>21.</b>
                        
                        JSON、滑杆的运用与数据过滤
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="22" data-path="swiftui-core-data.html">
            
                
                    <a href="./swiftui-core-data.html">
                        <i class="fa fa-check"></i>
                        
                            <b>22.</b>
                        
                        如何使用 Core Data 建立 ToDo App
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="23" data-path="swiftui-uikit.html">
            
                
                    <a href="./swiftui-uikit.html">
                        <i class="fa fa-check"></i>
                        
                            <b>23.</b>
                        
                        利用 UIViewRepresentable 整合UIKit 组件
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="24" data-path="swiftui-searchbar.html">
            
                
                    <a href="./swiftui-searchbar.html">
                        <i class="fa fa-check"></i>
                        
                            <b>24.</b>
                        
                        建立搜寻栏视图并使用自订绑定（Custom Binding）
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="25" data-path="swiftui-real-world-app.html">
            
                
                    <a href="./swiftui-real-world-app.html">
                        <i class="fa fa-check"></i>
                        
                            <b>25.</b>
                        
                        把所学应用出来！构建个人理财App
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="26" data-path="swiftui-appstoreanimation.html">
            
                
                    <a href="./swiftui-appstoreanimation.html">
                        <i class="fa fa-check"></i>
                        
                            <b>26.</b>
                        
                        创建类似App Store使用的动画视图转换
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="27" data-path="swiftui-carousel.html">
            
                
                    <a href="./swiftui-carousel.html">
                        <i class="fa fa-check"></i>
                        
                            <b>27.</b>
                        
                        如何建立图像轮播（Image Carousel）
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="28" data-path="swiftui-expandable-list.html">
            
                
                    <a href="./swiftui-expandable-list.html">
                        <i class="fa fa-check"></i>
                        
                            <b>28.</b>
                        
                        如何建立展开式列表视图和大纲视图
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="29" data-path="swiftui-gridlayout.html">
            
                
                    <a href="./swiftui-gridlayout.html">
                        <i class="fa fa-check"></i>
                        
                            <b>29.</b>
                        
                        使用 LazyVGrid 和 LazyHGrid 构建集合视图
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="30" data-path="swiftui-progress-ring.html">
            
                
                    <a href="./swiftui-progress-ring.html">
                        <i class="fa fa-check"></i>
                        
                            <b>30.</b>
                        
                        使用 Shape 和 Animatable 开发带动画的环形进度条
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="31" data-path="swiftui-library.html">
            
                
                    <a href="./swiftui-library.html">
                        <i class="fa fa-check"></i>
                        
                            <b>31.</b>
                        
                        如何使用 AnimatableModifier 和 LibraryContentProvider
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="32" data-path="swiftui-texteditor.html">
            
                
                    <a href="./swiftui-texteditor.html">
                        <i class="fa fa-check"></i>
                        
                            <b>32.</b>
                        
                        使用 TextEditor 支持多行文字输入
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="33" data-path="swiftui-matchedgeometry.html">
            
                
                    <a href="./swiftui-matchedgeometry.html">
                        <i class="fa fa-check"></i>
                        
                            <b>33.</b>
                        
                        使用 matchedGeometryEffect为 App 建立绚丽的视图动画
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="34" data-path="swiftui-grid-animation.html">
            
                
                    <a href="./swiftui-grid-animation.html">
                        <i class="fa fa-check"></i>
                        
                            <b>34.</b>
                        
                        ScrollViewReader 和网格动画
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="35" data-path="swiftui-tabview.html">
            
                
                    <a href="./swiftui-tabview.html">
                        <i class="fa fa-check"></i>
                        
                            <b>35.</b>
                        
                        标签视图的运用与自订标签列
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="36" data-path="swiftui-asyncimage.html">
            
                
                    <a href="./swiftui-asyncimage.html">
                        <i class="fa fa-check"></i>
                        
                            <b>36.</b>
                        
                        利用 AsyncImage 非同步加载和显示图像
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="37" data-path="swiftui-searchable.html">
            
                
                    <a href="./swiftui-searchable.html">
                        <i class="fa fa-check"></i>
                        
                            <b>37.</b>
                        
                        利用 Searchable 建立搜寻栏
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="38" data-path="swiftui-charts.html">
            
                
                    <a href="./swiftui-charts.html">
                        <i class="fa fa-check"></i>
                        
                            <b>38.</b>
                        
                        利用 Charts 框架建立图表
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="39" data-path="swiftui-live-text.html">
            
                
                    <a href="./swiftui-live-text.html">
                        <i class="fa fa-check"></i>
                        
                            <b>39.</b>
                        
                        利用 Live Text API 从图片中撷取文本
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="40" data-path="swiftui-sharelink.html">
            
                
                    <a href="./swiftui-sharelink.html">
                        <i class="fa fa-check"></i>
                        
                            <b>40.</b>
                        
                        通过 ShareLink 来分享文本和图像等数据
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="41" data-path="swiftui-imagerenderer.html">
            
                
                    <a href="./swiftui-imagerenderer.html">
                        <i class="fa fa-check"></i>
                        
                            <b>41.</b>
                        
                        利用 ImageRenderer API 轻松把 SwiftUI 视图转换为图像
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="42" data-path="swiftui-pdf-doc.html">
            
                
                    <a href="./swiftui-pdf-doc.html">
                        <i class="fa fa-check"></i>
                        
                            <b>42.</b>
                        
                        如何把 SwiftUI 视图转换为 PDF 文件
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="43" data-path="swiftui-gauge.html">
            
                
                    <a href="./swiftui-gauge.html">
                        <i class="fa fa-check"></i>
                        
                            <b>43.</b>
                        
                        使用 Gauge 视图显示进度并创建速度计
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="44" data-path="swiftui-grid.html">
            
                
                    <a href="./swiftui-grid.html">
                        <i class="fa fa-check"></i>
                        
                            <b>44.</b>
                        
                        使用Grid API 创建网格布局
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="45" data-path="swiftui-anylayout.html">
            
                
                    <a href="./swiftui-anylayout.html">
                        <i class="fa fa-check"></i>
                        
                            <b>45.</b>
                        
                        利用 AnyLayout 切换 UI 布局
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="46" data-path="swiftui-navigationstack.html">
            
                
                    <a href="./swiftui-navigationstack.html">
                        <i class="fa fa-check"></i>
                        
                            <b>46.</b>
                        
                        使用新的 NavigationStack 视图构建数据导向的导航
                    </a>
                
            
            
        </li>
    


        
        <li class="divider"></li>
        <li>
            <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                本书使用 GitBook 释出
            </a>
        </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="目录"><i class="fa fa-align-justify"></i></a>
    <a href="#" class="btn pull-left toggle-search" aria-label="搜寻"><i class="fa fa-search"></i></a>
    
    <div id="font-settings-wrapper" class="dropdown pull-left">
        <a href="#" class="btn toggle-dropdown" aria-label="字型设定"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="buttons">
        <button type="button" id="reduce-font-size" class="button size-2">A</button>
        <button type="button" id="enlarge-font-size" class="button size-2">A</button>
    </div>

    <div class="buttons font-family-list">
        <button type="button" data-font="0" class="button">衬线体</button>
        <button type="button" data-font="1" class="button">无衬线体</button>
    </div>

    <div class="buttons color-theme-list">
        <button type="button" id="color-theme-preview-0" class="button size-3" data-theme="0">白色</button>
        <button type="button" id="color-theme-preview-1" class="button size-3" data-theme="1">棕褐色</button>
        <button type="button" id="color-theme-preview-2" class="button size-3" data-theme="2">夜间</button>
    </div>
</div>

    </div>

    <!-- Actions Right -->
    
    <div class="dropdown pull-right">
        <a href="#" class="btn toggle-dropdown" aria-label="分享"><i class="fa fa-share-alt"></i>
        </a>
        <div class="dropdown-menu font-settings dropdown-left">
            <div class="dropdown-caret">
                <span class="caret-outer"></span>
                <span class="caret-inner"></span>
            </div>
            <div class="buttons">
                <button type="button" data-sharing="twitter" class="button">
                    分享到 Twitter
                </button>
                <button type="button" data-sharing="google-plus" class="button">
                    分享到 Google
                </button>
                <button type="button" data-sharing="facebook" class="button">
                    分享到 Facebook
                </button>
                <button type="button" data-sharing="weibo" class="button">
                    分享到 Weibo
                </button>
                <button type="button" data-sharing="instapaper" class="button">
                    分享到 Instapaper
                </button>
            </div>
        </div>
    </div>
    

    
    
    
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="./" >精通 SwiftUI - iOS 16 版</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <h1 id="%E7%AC%AC-15-%E7%AB%A0-br-%E4%BD%BF%E7%94%A8combine%E8%88%87%E8%A6%96%E5%9C%96%E6%A8%A1%E5%9E%8B%E5%BB%BA%E7%AB%8B%E8%A8%BB%E5%86%8A%E8%A1%A8%E5%96%AE">第 15 章<br>使用Combine与视图模型建立注册表单</h1>
<p>现在你应该对于 Combine 有了基本的了解，我们将继续探索 Combine 如何使 SwiftUI 出类拔萃。当开发一个真实的 App 时，让使用者注册帐户是很常见的。在本章中，我将建立一个带有三个文字栏位的简单注册画面。我们的重点是表单验证，因此将不进行实际注册，你将学习如何利用Combine 的强大功能，来验证每个输入栏位，并在视图模型中编写代码。</p>
<figure id="fig15.1"><img src="images/registration/swiftui-registration-1.png" alt="图 15.1.　使用者注册示例"><figcaption>图 15.1.　使用者注册示例</figcaption></figure>
<p>在深入研究代码之前，请先看一下图 15.1，这是我们将建立的使用者注册画面。在每个输入栏位下会列出要求，一旦使用者填入资讯后，App 就会即时验证所输入的资讯， 如果验证结果正确，则栏位要求文字就会划掉。而在满足所有的要求之前，将先禁用“注册”（Sign up ）按钮。</p>
<p>如果你对 Swift 与 UIKit 有一些经验，你就会知道有各种类型的实现方式可处理表单验证。不过，在本章中，我们将探索如何利用 Combine 框架来执行表单验证。</p>
<h3 id="%E4%BD%BF%E7%94%A8-swiftui-%E4%BD%88%E5%B1%80%E8%A1%A8%E5%96%AE">使用 SwiftUI 布局表单</h3>
<p>我们从一个练习来开始本章，使用至目前为止所学的内容，来布局如图 15.1 所示的表单 UI。要在 SwiftUI 中建立一个文字栏位，你可以使用 TextField 组件，而对于密码栏位， SwiftUI 提供了一个名为 <code>SecureField</code>安全文字栏位。</p>
<p>要建立一个文字栏位，需要使用栏位名称与绑定（binding ）来初始化 TextField，这将渲染一个可编辑的文字栏位，而使用者输入会储存在给定的绑定中。和其他表单栏位类似，你可以通过使用相关的修饰器来修改它的外观。下面是示例代码片段： </p>
<pre><code class="lang-swift"><span class="hljs-type">TextField</span>(<span class="hljs-string">&quot;Username&quot;</span>, text: $username)
    .font(.system(size: <span class="hljs-number">20</span>, weight: .semibold, design: .rounded))
    .padding(.horizontal)
</code></pre>
<p>这两个组件的用法非常相似，除了安全栏位会自动遮蔽使用者的输入： </p>
<pre><code class="lang-swift"><span class="hljs-type">SecureField</span>(<span class="hljs-string">&quot;Password&quot;</span>, text: $password)
    .font(.system(size: <span class="hljs-number">20</span>, weight: .semibold, design: .rounded))
    .padding(.horizontal)
</code></pre>
<p>我知道这两个组件对你而言比较陌生，不过在观看解答之前，试着尽力建立表单。</p>
<p>那么，你能建立表单吗？即使你无法完成这个练习，也没有关系，现在至 <a href="https://www.appcoda.com/resources/swiftui4/SwiftUIFormRegistrationUI.zip" target="_blank">https://www.appcoda.com/resources/swiftui4/SwiftUIFormRegistrationUI.zip</a> 。来下载这个项目。我将会介绍我的做法让你参考。</p>
<figure id="fig15.2"><img src="images/registration/swiftui-registration-2.png" alt="图 15.2　起始项目"><figcaption>图 15.2　起始项目</figcaption></figure>
<p>开启 <code>ContentView.swift</code> 档，并预览画布中的布局，你渲染的视图应该如图 15.2 所示。现在，我们简要检视一下代码，并从 <code>RequirementText</code> 视图开始。</p>
<pre><code class="lang-swift"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">RequirementText</span>: <span class="hljs-title">View</span> </span>{

    <span class="hljs-keyword">var</span> iconName = <span class="hljs-string">&quot;xmark.square&quot;</span>
    <span class="hljs-keyword">var</span> iconColor = <span class="hljs-type">Color</span>(red: <span class="hljs-number">251</span>/<span class="hljs-number">255</span>, green: <span class="hljs-number">128</span>/<span class="hljs-number">255</span>, blue: <span class="hljs-number">128</span>/<span class="hljs-number">255</span>)

    <span class="hljs-keyword">var</span> text = <span class="hljs-string">&quot;&quot;</span>
    <span class="hljs-keyword">var</span> isStrikeThrough = <span class="hljs-built_in">false</span>

    <span class="hljs-keyword">var</span> body: some <span class="hljs-type">View</span> {
        <span class="hljs-type">HStack</span> {
            <span class="hljs-type">Image</span>(systemName: iconName)
                .foregroundColor(iconColor)
            <span class="hljs-type">Text</span>(text)
                .font(.system(.body, design: .rounded))
                .foregroundColor(.secondary)
                .strikethrough(isStrikeThrough)
            <span class="hljs-type">Spacer</span>()
        }
    }
}
</code></pre>
<p>首先，为什么我对栏位要求文字建立一个单独视图（如图 15.3 所示）？如果你检视任何一个栏位要求文字，它都有一个图示及一个叙述。我们无须从头开始建立每一个栏位要求文字，我们可以将代码一般化，并为其建立一个通用的代码。</p>
<figure id="fig15.3"><img src="images/registration/swiftui-registration-3.png" alt="图 15.3　示例文字栏位及其要求文字"><figcaption>图 15.3　示例文字栏位及其要求文字</figcaption></figure>
<p><code>RequirementText</code> 视图有四个属性，包括 <code>iconName</code>、<code>iconColor</code>、<code>text</code>与  <code>isStrikeThrough</code>。它足以弹性支持栏位要求文字的不同样式，如果你接受默认的图示与颜色，则可建立如下的栏位要求文字： </p>
<pre><code class="lang-swift"><span class="hljs-type">RequirementText</span>(text: <span class="hljs-string">&quot;A minimum of 4 characters&quot;</span>)
</code></pre>
<p>这将渲染如图 15.3 所示的栏位要求文字。在某些情况下，应要划掉栏位要求文字，并显示不同的图示或颜色。代码可撰写如下： </p>
<pre><code class="lang-swift"><span class="hljs-type">RequirementText</span>(iconName: <span class="hljs-string">&quot;lock.open&quot;</span>, iconColor: <span class="hljs-type">Color</span>.secondary, text: <span class="hljs-string">&quot;A minimum of 8 characters&quot;</span>, isStrikeThrough: <span class="hljs-built_in">true</span>)
</code></pre>
<p>你可指定一个不同的系统图示名称、颜色，并将 <code>isStrikeThrough</code> 选项设定为 <code>true</code>，这可让你建立如图 15.4 所示的栏位要求文字。</p>
<figure id="fig15.4"><img src="images/registration/swiftui-registration-4.png" alt="图 15.4.　栏位要求文字被划掉"><figcaption>图 15.4.　栏位要求文字被划掉</figcaption></figure>
<p>现在，你应该了解 <code>RequirementText</code> 视图的工作原理，以及为何建立它。我们来看一下FormField 视图。同样的，如果你检视所有的文字栏位，它们都有一个共同的样式，即圆体字型样式的文字栏位，这就是为何我取出一些通用代码，并建立 <code>FormField</code> 视图的原因。</p>
<pre><code class="lang-swift"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">FormField</span>: <span class="hljs-title">View</span> </span>{
    <span class="hljs-keyword">var</span> fieldName = <span class="hljs-string">&quot;&quot;</span>
    @<span class="hljs-type">Binding</span> <span class="hljs-keyword">var</span> fieldValue: <span class="hljs-type">String</span>

    <span class="hljs-keyword">var</span> isSecure = <span class="hljs-built_in">false</span>

    <span class="hljs-keyword">var</span> body: some <span class="hljs-type">View</span> {

        <span class="hljs-type">VStack</span> {
            <span class="hljs-keyword">if</span> isSecure {
                <span class="hljs-type">SecureField</span>(fieldName, text: $fieldValue)
                    .font(.system(size: <span class="hljs-number">20</span>, weight: .semibold, design: .rounded))
                    .padding(.horizontal)

            } <span class="hljs-keyword">else</span> {
                <span class="hljs-type">TextField</span>(fieldName, text: $fieldValue)                 
                    .font(.system(size: <span class="hljs-number">20</span>, weight: .semibold, design: .rounded))
                    .padding(.horizontal)
            }

            <span class="hljs-type">Divider</span>()
                .frame(height: <span class="hljs-number">1</span>)
                .background(<span class="hljs-type">Color</span>(red: <span class="hljs-number">240</span>/<span class="hljs-number">255</span>, green: <span class="hljs-number">240</span>/<span class="hljs-number">255</span>, blue: <span class="hljs-number">240</span>/<span class="hljs-number">255</span>))
                .padding(.horizontal)

        }
    }
}
</code></pre>
<p>由于这个通用的 <code>FormField</code> 需要同时负责文字栏位与安全栏位，因此它有一个名为 <code>isSecure</code>的属性。如果设定为 <code>true</code>，表单栏位将建立为安全栏位。在 SwiftUI 中，你可以使用 <code>Divider</code> 组件来建立一条线。在代码中，我们使用 <code>frame</code> 修饰器来变更高度为“1 点”。</p>
<p>要建立使用者名称栏位，你可以将代码撰写如下： </p>
<pre><code class="lang-swift"><span class="hljs-type">FormField</span>(fieldName: <span class="hljs-string">&quot;Username&quot;</span>, fieldValue: $username)
</code></pre>
<p>对于密码栏位，除了 <code>isSecure</code> 参数设定为 true 之外，代码也非常相似： </p>
<pre><code class="lang-swift"><span class="hljs-type">FormField</span>(fieldName: <span class="hljs-string">&quot;Password&quot;</span>, fieldValue: $password, isSecure: <span class="hljs-built_in">true</span>)
</code></pre>
<p>那么，我们回到 <code>ContentView</code> 结构，来看表单是如何布局。</p>
<pre><code class="lang-swift"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ContentView</span>: <span class="hljs-title">View</span> </span>{

    @<span class="hljs-type">State</span> private <span class="hljs-keyword">var</span> username = <span class="hljs-string">&quot;&quot;</span>
    @<span class="hljs-type">State</span> private <span class="hljs-keyword">var</span> password = <span class="hljs-string">&quot;&quot;</span>
    @<span class="hljs-type">State</span> private <span class="hljs-keyword">var</span> passwordConfirm = <span class="hljs-string">&quot;&quot;</span>

    <span class="hljs-keyword">var</span> body: some <span class="hljs-type">View</span> {
        <span class="hljs-type">VStack</span> {
            <span class="hljs-type">Text</span>(<span class="hljs-string">&quot;Create an account&quot;</span>)
                .font(.system(.largeTitle, design: .rounded))
                .bold()
                .padding(.bottom, <span class="hljs-number">30</span>)

            <span class="hljs-type">FormField</span>(fieldName: <span class="hljs-string">&quot;Username&quot;</span>, fieldValue: $username)
            <span class="hljs-type">RequirementText</span>(text: <span class="hljs-string">&quot;A minimum of 4 characters&quot;</span>)
                .padding()

            <span class="hljs-type">FormField</span>(fieldName: <span class="hljs-string">&quot;Password&quot;</span>, fieldValue: $password, isSecure: <span class="hljs-built_in">true</span>)
            <span class="hljs-type">VStack</span> {
                <span class="hljs-type">RequirementText</span>(iconName: <span class="hljs-string">&quot;lock.open&quot;</span>, iconColor: <span class="hljs-type">Color</span>.secondary, text: <span class="hljs-string">&quot;A minimum of 8 characters&quot;</span>, isStrikeThrough: <span class="hljs-built_in">true</span>)
                <span class="hljs-type">RequirementText</span>(iconName: <span class="hljs-string">&quot;lock.open&quot;</span>, text: <span class="hljs-string">&quot;One uppercase letter&quot;</span>, isStrikeThrough: <span class="hljs-built_in">false</span>)
            }
            .padding()

            <span class="hljs-type">FormField</span>(fieldName: <span class="hljs-string">&quot;Confirm Password&quot;</span>, fieldValue: $passwordConfirm, isSecure: <span class="hljs-built_in">true</span>)
            <span class="hljs-type">RequirementText</span>(text: <span class="hljs-string">&quot;Your confirm password should be the same as password&quot;</span>, isStrikeThrough: <span class="hljs-built_in">false</span>)
                .padding()
                .padding(.bottom, <span class="hljs-number">50</span>)

            <span class="hljs-type">Button</span>(action: {
                <span class="hljs-comment">// 进入下一个画面</span>
            }) {
                <span class="hljs-type">Text</span>(<span class="hljs-string">&quot;Sign Up&quot;</span>)
                    .font(.system(.body, design: .rounded))
                    .foregroundColor(.white)
                    .bold()
                    .padding()
                    .frame(minWidth: <span class="hljs-number">0</span>, maxWidth: .infinity)
                    .background(<span class="hljs-type">LinearGradient</span>(gradient: <span class="hljs-type">Gradient</span>(colors: [<span class="hljs-type">Color</span>(red: <span class="hljs-number">251</span>/<span class="hljs-number">255</span>, green: <span class="hljs-number">128</span>/<span class="hljs-number">255</span>, blue: <span class="hljs-number">128</span>/<span class="hljs-number">255</span>), <span class="hljs-type">Color</span>(red: <span class="hljs-number">253</span>/<span class="hljs-number">255</span>, green: <span class="hljs-number">193</span>/<span class="hljs-number">255</span>, blue: <span class="hljs-number">104</span>/<span class="hljs-number">255</span>)]), startPoint: .leading, endPoint: .trailing))
                    .cornerRadius(<span class="hljs-number">10</span>)
                    .padding(.horizontal)

            }

            <span class="hljs-type">HStack</span> {
                <span class="hljs-type">Text</span>(<span class="hljs-string">&quot;Already have an account?&quot;</span>)
                    .font(.system(.body, design: .rounded))
                    .bold()

                <span class="hljs-type">Button</span>(action: {
                    <span class="hljs-comment">// 进入登入画面</span>
                }) {
                    <span class="hljs-type">Text</span>(<span class="hljs-string">&quot;Sign in&quot;</span>)
                        .font(.system(.body, design: .rounded))
                        .bold()
                        .foregroundColor(<span class="hljs-type">Color</span>(red: <span class="hljs-number">251</span>/<span class="hljs-number">255</span>, green: <span class="hljs-number">128</span>/<span class="hljs-number">255</span>, blue: <span class="hljs-number">128</span>/<span class="hljs-number">255</span>))
                }
            }.padding(.top, <span class="hljs-number">50</span>)

            <span class="hljs-type">Spacer</span>()
        }
        .padding()
    }

}
</code></pre>
<p>首先，我们有一个 <code>VStack</code> 存放所有的表单元素，它由标题开始，接着是所有的表单栏位与栏位要求文字。我已经解释过这些表单栏位与栏位要求文字是如何建立的，因此我将不再详细说明。我加入栏位的是 <code>padding</code> 修饰器，这可以让文字栏位之间加入间距。</p>
<p>“注册”按钮是使用 <code>Button</code> 组件所建立，目前没有动作。我打算将这个动作闭包留空， 因为我们的重点是表单验证。同样的，我相信你应该知道如何自订按钮，因此我将不再对其详细介绍，你可以随时参考按钮一章的内容。</p>
<p>最后，是“已经有帐号”的叙述文字，这个文字与“登入”按钮并不一定需要，我只是想模仿常见的注册表单。</p>
<p>以上是我布局使用者注册画面的方式。如果你已试着做这个练习，或许可提出其他的解决方案，这完全没问题。我只是告诉你建立表单的其中一种方法，你可以使用它作为参考，并提出更好的实现方式。</p>
<h3 id="%E4%BA%86%E8%A7%A3-combine">了解 Combine</h3>
<p>在深入研究表单验证代码之前，我们先来了解更多关于 Combine 框架的背景资讯。如前一章所述，这个新框架提供了一个声明式API，用于随着时间处理值。</p>
<p>“随着时间处理值”是什么意思？这些值又是什么？ </p>
<p>我们以注册表单为例。App 与使用者互动时，持续产生 UI 事件，假设使用者在文字栏位中输入的每个按键，都会触发一个事件，而这可以成为值的串流，如图 15.5 所示。</p>
<figure id="fig15.5"><img src="images/registration/swiftui-registration-5.png" alt="图 15.5.　输入数据串流"><figcaption>图 15.5.　输入数据串流</figcaption></figure>
<p>这些 UI 事件是框架所参照的一种类型的值。这些值的另一个例子是网路事件（例如： 从远端服务器下载一个文件）。</p>
<blockquote>
<p>Combine 框架提供一个声明式方法，供App 处理事件。你可以为给定的事件源建立单一处理链（chain），而不是实现多个委派回呼（delegate callback ）或完成处理闭包（completion handler closure ）。链的每一个部分都是一个Combine 运算子，对上一个步骤收到的元素执行不同的动作。</p>
<p>- Apple 的官方文件 (<a href="https://developer.apple.com/documentation/combine/receiving_and_handling_events_with_combine" target="_blank">https://developer.apple.com/documentation/combine/receiving_and_handling_events_with_combine</a>)</p>
</blockquote>
<p>发布者与订阅者是框架的两个核心元素。使用 Combine，发布者传送事件，订阅者订阅，以从发布者接收值。同样的，我们以文字栏位为例。通过使用 Combine，使用者在文字栏位中输入的每个按键，都会触发一个值更改的事件。而对监控这些值感兴趣的订阅者，可以订阅接收这些事件，并进一步执行操作（例如：验证）。</p>
<p>举例而言，你正在写一个表单验证器，它有指示表单是否准备好送出的属性。在这个例子中，你可以使用<code>@Published</code> 标注来标记该属性，如下所示： </p>
<pre><code class="lang-swift"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FormValidator</span>: <span class="hljs-title">ObservableObject</span> </span>{
    @<span class="hljs-type">Published</span> <span class="hljs-keyword">var</span> isReadySubmit: <span class="hljs-type">Bool</span> = <span class="hljs-built_in">false</span>
}
</code></pre>
<p>每次变更 <code>isReadySubmit</code> 的值时，它都会向订阅者发布一个事件。订阅者接收更新后的值，并继续处理，例如：订阅者可以使用该值来判断是否应启用“送出”按钮。</p>
<p>你可能会觉得在 SwiftUI 中 <code>@Published</code> 和 <code>@State</code> 的运作方式非常相似。虽然在这个例子，它的工作原理几乎相同，不过 <code>@State</code> 只能应用在属于特定SwiftUI 视图的属性。如果你想要建立不属于特定视图或可以用于多个视图的自订类型的话，则你需要建立一个遵守 <code>ObservableObject</code> 的类别，并以 <code>@Published</code> 标注来标记这些属性。</p>
<h3 id="combine-%E8%88%87-mvvm">Combine 与 MVVM</h3>
<p>现在你应该具备 Combine 的一些基本观念，我们来开始使用框架实现表单验证，下列是我们将要做的事情： </p>
<ol>
<li>建立一个视图模型来表示使用者注册表单。</li>
<li>在视图模型中实现表单验证。</li>
</ol>
<p>我知道你心里可能会有几个问题。首先，为什么我们需要建立视图模型呢？我们可以在 ContentView 加入这些表单属性并执行表单验证吗？ </p>
<p>你绝对可以这样做，但是随着项目规模持续成长，或者视图变得更加复杂，将复杂的组件拆成多层是一个良好做法。</p>
<p>“关注点分离”（Separation of concerns ）是编写优秀软体的基本原则。我们可以把视图分成视图及其视图模型等两个组件，而不是将所有的东西放在一个视图中。视图本身是负责 UI 布局，而视图模型存放要在视图中显示的状态与数据，并且视图模型还处理数据验证与转换。对于有经验的开发者而言，你知道我们正应用众所周知的“MVVM”（Model- View-ViewModel 的缩写）设计模式。</p>
<p>所以，这个视图模型将保存哪些数据呢？ </p>
<p>再看一次注册表单，我们有三个文字栏位，包括： </p>
<ul>
<li>使用者名称。</li>
<li>密码。</li>
<li>密码确认。</li>
</ul>
<p>除此之外，这个视图模型将存放这些栏位要求文字的状态，以指示是否应该删掉它们：</p>
<ul>
<li>最少4个字元（使用者名称）。</li>
<li>最少8个字元（密码）。</li>
<li>一个大写字母（密码）。</li>
<li>你的确认密码应与密码相同（密码确认）。</li>
</ul>
<p>因此，视图模型将具有七个属性，并且每一个属性将其值的变更发布给那些有兴趣接收值的人。视图模型的基本架构可以定义如下： </p>
<pre><code class="lang-swift"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserRegistrationViewModel</span>: <span class="hljs-title">ObservableObject</span> </span>{
    <span class="hljs-comment">// Input</span>
    @<span class="hljs-type">Published</span> <span class="hljs-keyword">var</span> username = <span class="hljs-string">&quot;&quot;</span>
    @<span class="hljs-type">Published</span> <span class="hljs-keyword">var</span> password = <span class="hljs-string">&quot;&quot;</span>
    @<span class="hljs-type">Published</span> <span class="hljs-keyword">var</span> passwordConfirm = <span class="hljs-string">&quot;&quot;</span>

    <span class="hljs-comment">// Output</span>
    @<span class="hljs-type">Published</span> <span class="hljs-keyword">var</span> isUsernameLengthValid = <span class="hljs-built_in">false</span>
    @<span class="hljs-type">Published</span> <span class="hljs-keyword">var</span> isPasswordLengthValid = <span class="hljs-built_in">false</span>
    @<span class="hljs-type">Published</span> <span class="hljs-keyword">var</span> isPasswordCapitalLetter = <span class="hljs-built_in">false</span>
    @<span class="hljs-type">Published</span> <span class="hljs-keyword">var</span> isPasswordConfirmValid = <span class="hljs-built_in">false</span>
}
</code></pre>
<p>这就是表单视图的数据模型。<code>username</code>、<code>password</code> 与 <code>passwordConfirm</code> 属性分别存放使用者名称、密码与密码确认的文字栏位的值。这个类别应该遵守 <code>ObservableObject</code>。所有这些属性都使用 <code>@Published</code> 来做标注，因为我们想要在值发生变更时通知订阅者，并相应执行验证。</p>
<h4 id="%E4%BD%BF%E7%94%A8combine-%E9%A9%97%E8%AD%89%E4%BD%BF%E7%94%A8%E8%80%85%E5%90%8D%E7%A8%B1">使用Combine 验证使用者名称</h4>
<p>好的，以上为数据模型，不过我们还没有处理表单验证。我们要如何依照要求来验证使用者名称、密码与密码确认呢？ </p>
<p>使用 Combine，你就必须培养发布者/ 订阅者思维模式来解决问题。考虑到使用者名称， 我们这里其实有两个发布者：<code>username</code> 与<code>isUsernameLengthValid</code>。每当使用者在使用者名称栏位上敲击键盘输入时，<code>username</code> 发布者就会发布值的变更，而 <code>isUsernameLengthValid</code> 发布者将使用者输入的验证状态通知订阅者。几乎所有SwiftUI 中的控制组件都是订阅者，因此栏位要求文字视图将监听验证结果的变化，并相应更新其样式（即是否有删除线）。图15.6 说明了我们如何使用 Combine 来验证使用者名称的输入。</p>
<figure id="fig15.6"><img src="images/registration/swiftui-registration-6.png" alt="图 15.6.　username 与 isUsernameValid 发布者"><figcaption>图 15.6.　username 与 isUsernameValid 发布者</figcaption></figure>
<p>这里缺少的是连接两个发布者之间的东西，并且这个“东西”要处理下列的任务： </p>
<ul>
<li>监听 <code>username</code> 的变化。</li>
<li>验证使用者名称与回传验证结果（true/false）。</li>
<li>指定结果至 <code>isUsernameLengthValid</code>。</li>
</ul>
<p>如果你将以上的需求转换成代码，下面是代码片段： </p>
<pre><code class="lang-swift">$username
    .receive(on: <span class="hljs-type">RunLoop</span>.main)
    .<span class="hljs-built_in">map</span> { username <span class="hljs-keyword">in</span>
        <span class="hljs-keyword">return</span> username.<span class="hljs-built_in">count</span> &gt;= <span class="hljs-number">4</span>
    }
    .assign(to: \.isUsernameLengthValid, on: <span class="hljs-keyword">self</span>)
</code></pre>
<p>Combine 框架提供两个内建的订阅者：“sink”与“assign”。 <code>sink</code> 建立一个通用订阅者来接收值，<code>assign</code> 则让你建立另一种类型的订阅者，用于更新物件的特定属性。举例而言，它将验证结果（true/false ）指定给 <code>isUsernameLengthValid</code>。</p>
<p>我将深入说明并逐行检视上列的代码。<code>$username</code> 是我们想要监听的变更值的来源。由于我们订阅 UI 事件的变化，因此调用 <code>receive(on:)</code> 函数来确保订阅者在主执行绪（即 <code>RunLoop.main</code> ）上接收到值。</p>
<p>发布者传送的值是使用者所输入的使用者名称，不过订阅者感兴趣的是使用者名称的长度是否能够满足最低要求。这里，<code>map</code> 函数被认为是Combine 中的运算子，它接受输入、处理输入，并将输入转换为订阅者所期望的内容，因此我们在上列的代码中做了下列事情：</p>
<ol>
<li>我们将使用者名称作为输入。</li>
<li>然后，我们验证使用者名称并确认至少有4个字元，并验证其是否至少包含4个字元。</li>
<li>最后，我们将验证结果以布林值回传给订阅者。</li>
</ol>
<p>对于验证结果， 订阅者只需将结果设定给 <code>isUsernameLengthValid</code> 属性。请记得 <code>isUsernameLengthValid</code> 也是一个发布者，我们可以更新 <code>RequirementText</code> 控制组件来订阅变更，并相应更新 UI，如下所示： </p>
<pre><code class="lang-swift"><span class="hljs-type">RequirementText</span>(iconColor: userRegistrationViewModel.isUsernameLengthValid ? <span class="hljs-type">Color</span>.secondary : <span class="hljs-type">Color</span>(red: <span class="hljs-number">251</span>/<span class="hljs-number">255</span>, green: <span class="hljs-number">128</span>/<span class="hljs-number">255</span>, blue: <span class="hljs-number">128</span>/<span class="hljs-number">255</span>), text: <span class="hljs-string">&quot;A minimum of 4 characters&quot;</span>, isStrikeThrough: userRegistrationViewModel.isUsernameLengthValid)
</code></pre>
<p>图示的颜色与删除线的状态都取决于验证结果而定（也就是 <code>isUsernameLengthValid</code> ）。</p>
<p>这就是我们如何使用 Combine 来验证表单栏位的方式。我们还没有将代码变更放入我们的项目中，不过我希望让你了解发布者/ 订阅者的观念，以及我们如何使用这个方法执行验证。在后面的小节中，我们将应用所学的知识，并对代码进行更改。</p>
<h4 id="%E4%BD%BF%E7%94%A8-combine-%E9%A9%97%E8%AD%89%E5%AF%86%E7%A2%BC">使用 Combine 验证密码</h4>
<p>如果你了解使用者名称栏位的验证是如何完成的，我们将对密码与密码确认验证应用类似的实现。</p>
<p>对于密码栏位，有两个要求： </p>
<ol>
<li>密码长度至少有 8 个字元。</li>
<li>应至少包含一个大写字母。</li>
</ol>
<p>为此，我们可以设定两个订阅者，如下所示： </p>
<pre><code class="lang-swift">$password
    .receive(on: <span class="hljs-type">RunLoop</span>.main)
    .<span class="hljs-built_in">map</span> { password <span class="hljs-keyword">in</span>
        <span class="hljs-keyword">return</span> password.<span class="hljs-built_in">count</span> &gt;= <span class="hljs-number">8</span>
    }
    .assign(to: \.isPasswordLengthValid, on: <span class="hljs-keyword">self</span>)

$password
    .receive(on: <span class="hljs-type">RunLoop</span>.main)
    .<span class="hljs-built_in">map</span> { password <span class="hljs-keyword">in</span>
        <span class="hljs-keyword">let</span> pattern = <span class="hljs-string">&quot;[A-Z]&quot;</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-number">_</span> = password.range(of: pattern, options: .regularExpression) {
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">true</span>
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">false</span>
        }
    }
    .assign(to: \.isPasswordCapitalLetter, on: <span class="hljs-keyword">self</span>)
</code></pre>
<p>第一个订阅者订阅了密码长度的验证结果，并指定给 <code>isPasswordLengthValid</code> 属性。第二个是处理大写字母的验证。我们使用 <code>range</code> 方法来测试密码是否至少包含一个大写字母。同样的，订阅者将验证结果直接指定给属性。</p>
<p>好的，剩下的是密码确认栏位的验证。对于这个栏位，输入要求是密码确认应与密码栏位的密码相同。<code>password</code> 与 <code>passwordConfirm</code> 都是发布者，为了验证两个发布者是否具有相同的值，我们使用 <code>Publisher.combineLatest</code>来接收与结合来自发布者的最新值，然后我们可以验证两个值是否相同。下列为代码片段： </p>
<pre><code class="lang-swift"><span class="hljs-type">Publishers</span>.<span class="hljs-type">CombineLatest</span>($password, $passwordConfirm)
    .receive(on: <span class="hljs-type">RunLoop</span>.main)
    .<span class="hljs-built_in">map</span> { (password, passwordConfirm) <span class="hljs-keyword">in</span>
        <span class="hljs-keyword">return</span> !passwordConfirm.isEmpty &amp;&amp; (passwordConfirm == password)
    }
    .assign(to: \.isPasswordConfirmValid, on: <span class="hljs-keyword">self</span>)
</code></pre>
<p>同样的，我们指定验证结果给 <code>isPasswordConfirmValid</code> 属性。</p>
<h4 id="%E5%AF%A6%E4%BD%9C-userregistrationviewmodel">实现 UserRegistrationViewModel</h4>
<p>现在我已经解释了实现的方法，我们将所有内容放至项目中。首先，使用 “Swift File” 模板建立一个新 Swift 档，命名为 <code>UserRegistrationViewModel.swift</code>，然后使用下列代码替换整个文件内容： </p>
<pre><code class="lang-swift"><span class="hljs-keyword">import</span> <span class="hljs-type">Foundation</span>
<span class="hljs-keyword">import</span> <span class="hljs-type">Combine</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserRegistrationViewModel</span>: <span class="hljs-title">ObservableObject</span> </span>{
    <span class="hljs-comment">// 输入</span>
    @<span class="hljs-type">Published</span> <span class="hljs-keyword">var</span> username = <span class="hljs-string">&quot;&quot;</span>
    @<span class="hljs-type">Published</span> <span class="hljs-keyword">var</span> password = <span class="hljs-string">&quot;&quot;</span>
    @<span class="hljs-type">Published</span> <span class="hljs-keyword">var</span> passwordConfirm = <span class="hljs-string">&quot;&quot;</span>

    <span class="hljs-comment">// 输出</span>
    @<span class="hljs-type">Published</span> <span class="hljs-keyword">var</span> isUsernameLengthValid = <span class="hljs-built_in">false</span>
    @<span class="hljs-type">Published</span> <span class="hljs-keyword">var</span> isPasswordLengthValid = <span class="hljs-built_in">false</span>
    @<span class="hljs-type">Published</span> <span class="hljs-keyword">var</span> isPasswordCapitalLetter = <span class="hljs-built_in">false</span>
    @<span class="hljs-type">Published</span> <span class="hljs-keyword">var</span> isPasswordConfirmValid = <span class="hljs-built_in">false</span>

    private <span class="hljs-keyword">var</span> cancellableSet: <span class="hljs-type">Set</span>&lt;<span class="hljs-type">AnyCancellable</span>&gt; = []

    <span class="hljs-keyword">init</span>() {
        $username
            .receive(on: <span class="hljs-type">RunLoop</span>.main)
            .<span class="hljs-built_in">map</span> { username <span class="hljs-keyword">in</span>
                <span class="hljs-keyword">return</span> username.<span class="hljs-built_in">count</span> &gt;= <span class="hljs-number">4</span>
            }
            .assign(to: \.isUsernameLengthValid, on: <span class="hljs-keyword">self</span>)
            .store(<span class="hljs-keyword">in</span>: &amp;cancellableSet)

        $password
            .receive(on: <span class="hljs-type">RunLoop</span>.main)
            .<span class="hljs-built_in">map</span> { password <span class="hljs-keyword">in</span>
                <span class="hljs-keyword">return</span> password.<span class="hljs-built_in">count</span> &gt;= <span class="hljs-number">8</span>
            }
            .assign(to: \.isPasswordLengthValid, on: <span class="hljs-keyword">self</span>)
            .store(<span class="hljs-keyword">in</span>: &amp;cancellableSet)

        $password
            .receive(on: <span class="hljs-type">RunLoop</span>.main)
            .<span class="hljs-built_in">map</span> { password <span class="hljs-keyword">in</span>
                <span class="hljs-keyword">let</span> pattern = <span class="hljs-string">&quot;[A-Z]&quot;</span>
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-number">_</span> = password.range(of: pattern, options: .regularExpression) {
                    <span class="hljs-keyword">return</span> <span class="hljs-built_in">true</span>
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">return</span> <span class="hljs-built_in">false</span>
                }
            }
            .assign(to: \.isPasswordCapitalLetter, on: <span class="hljs-keyword">self</span>)
            .store(<span class="hljs-keyword">in</span>: &amp;cancellableSet)

        <span class="hljs-type">Publishers</span>.<span class="hljs-type">CombineLatest</span>($password, $passwordConfirm)
            .receive(on: <span class="hljs-type">RunLoop</span>.main)
            .<span class="hljs-built_in">map</span> { (password, passwordConfirm) <span class="hljs-keyword">in</span>
                <span class="hljs-keyword">return</span> !passwordConfirm.isEmpty &amp;&amp; (passwordConfirm == password)
            }
            .assign(to: \.isPasswordConfirmValid, on: <span class="hljs-keyword">self</span>)
            .store(<span class="hljs-keyword">in</span>: &amp;cancellableSet)
    }
}
</code></pre>
<p>以上的代码几乎与前面章节的代码相同。要使用 Combine，你需要先汇入 Combine 框架。在 <code>init()</code> 方法中，我们初始化所有的订阅者来监听文字栏位的值的变更，并执行相应的验证。</p>
<p>代码与我们之前讨论的代码几乎相同，但你可能注意到一件事，即 <code>cancellableSet</code> 变量。对于每一个订阅者，我们在最后调用 <code>store</code> 函数。</p>
<p>这些是什么呢？ </p>
<p><code>assign</code> 函数建立订阅者，并回传一个可取消的实例。你可以使用该实例在适当的时间取消订阅。<code>store</code> 函数可让我们将可取消的的参照储存到一个集合中，以便稍后的清理。如果你不储存这个参照，则 App 可能出现记忆体泄漏的问题。</p>
<p>那么，这个示例何时会进行清理呢？由于 <code>cancellableSet</code> 被定义为该类别的属性，因此当类别被取消初始化时，将会对订阅进行清理及取消。</p>
<p>现在切换回 <code>ContentView.swift</code>，并更新 UI 控制组件。首先，将下列的状态变量： </p>
<pre><code class="lang-swift">@<span class="hljs-type">State</span> private <span class="hljs-keyword">var</span> username = <span class="hljs-string">&quot;&quot;</span>
@<span class="hljs-type">State</span> private <span class="hljs-keyword">var</span> password = <span class="hljs-string">&quot;&quot;</span>
@<span class="hljs-type">State</span> private <span class="hljs-keyword">var</span> passwordConfirm = <span class="hljs-string">&quot;&quot;</span>
</code></pre>
<p>以一个视图模型取代，并命名为 <code>userRegistrationViewModel</code>：</p>
<pre><code class="lang-swift">@<span class="hljs-type">ObservedObject</span> private <span class="hljs-keyword">var</span> userRegistrationViewModel = <span class="hljs-type">UserRegistrationViewModel</span>()
</code></pre>
<p>接下来，更新文字栏位与使用者名称的栏位要求文字如下： </p>
<pre><code class="lang-swift"><span class="hljs-type">FormField</span>(fieldName: <span class="hljs-string">&quot;Username&quot;</span>, fieldValue: $userRegistrationViewModel.username)
<span class="hljs-type">RequirementText</span>(iconColor: userRegistrationViewModel.isUsernameLengthValid ? <span class="hljs-type">Color</span>.secondary : <span class="hljs-type">Color</span>(red: <span class="hljs-number">251</span>/<span class="hljs-number">255</span>, green: <span class="hljs-number">128</span>/<span class="hljs-number">255</span>, blue: <span class="hljs-number">128</span>/<span class="hljs-number">255</span>), text: <span class="hljs-string">&quot;A minimum of 4 characters&quot;</span>, isStrikeThrough: userRegistrationViewModel.isUsernameLengthValid)
    .padding()
</code></pre>
<p>现在，<code>fieldValue</code> 参数已经变更为 <code>$userRegistrationViewModel.username</code>。对于栏位要求文字，SwiftUI 监控 <code>userRegistrationViewModel.isUsernameLengthValid</code> 属性，并相应更新栏位要求文字。</p>
<p>同样的，更新密码与密码确认栏位的UI 代码如下所示： </p>
<pre><code class="lang-swift"><span class="hljs-type">FormField</span>(fieldName: <span class="hljs-string">&quot;Password&quot;</span>, fieldValue: $userRegistrationViewModel.password, isSecure: <span class="hljs-built_in">true</span>)
<span class="hljs-type">VStack</span> {
    <span class="hljs-type">RequirementText</span>(iconName: <span class="hljs-string">&quot;lock.open&quot;</span>, iconColor: userRegistrationViewModel.isPasswordLengthValid ? <span class="hljs-type">Color</span>.secondary : <span class="hljs-type">Color</span>(red: <span class="hljs-number">251</span>/<span class="hljs-number">255</span>, green: <span class="hljs-number">128</span>/<span class="hljs-number">255</span>, blue: <span class="hljs-number">128</span>/<span class="hljs-number">255</span>), text: <span class="hljs-string">&quot;A minimum of 8 characters&quot;</span>, isStrikeThrough: userRegistrationViewModel.isPasswordLengthValid)
    <span class="hljs-type">RequirementText</span>(iconName: <span class="hljs-string">&quot;lock.open&quot;</span>, iconColor: userRegistrationViewModel.isPasswordCapitalLetter ? <span class="hljs-type">Color</span>.secondary : <span class="hljs-type">Color</span>(red: <span class="hljs-number">251</span>/<span class="hljs-number">255</span>, green: <span class="hljs-number">128</span>/<span class="hljs-number">255</span>, blue: <span class="hljs-number">128</span>/<span class="hljs-number">255</span>), text: <span class="hljs-string">&quot;One uppercase letter&quot;</span>, isStrikeThrough: userRegistrationViewModel.isPasswordCapitalLetter)
}
.padding()

<span class="hljs-type">FormField</span>(fieldName: <span class="hljs-string">&quot;Confirm Password&quot;</span>, fieldValue: $userRegistrationViewModel.passwordConfirm, isSecure: <span class="hljs-built_in">true</span>)
<span class="hljs-type">RequirementText</span>(iconColor: userRegistrationViewModel.isPasswordConfirmValid ? <span class="hljs-type">Color</span>.secondary : <span class="hljs-type">Color</span>(red: <span class="hljs-number">251</span>/<span class="hljs-number">255</span>, green: <span class="hljs-number">128</span>/<span class="hljs-number">255</span>, blue: <span class="hljs-number">128</span>/<span class="hljs-number">255</span>), text: <span class="hljs-string">&quot;Your confirm password should be the same as password&quot;</span>, isStrikeThrough: userRegistrationViewModel.isPasswordConfirmValid)
    .padding()
    .padding(.bottom, <span class="hljs-number">50</span>)
</code></pre>
<p>如此，现在可以测试 App 了。如果你已正确进行所有的修改，则 App 现在应该能验证使用者输入，如图 15.7 所示。</p>
<figure id="fig15.7"><img src="images/registration/swiftui-registration-7.png" alt="图 15.7.　注册表单现在可验证使用者输入"><figcaption>图 15.7.　注册表单现在可验证使用者输入</figcaption></figure>
<h3 id="%E6%9C%AC%E7%AB%A0%E5%B0%8F%E7%B5%90">本章小结</h3>
<p>我希望你现在已经掌握了一些 Combine 框架的基本认识。SwiftUI 与 Combine 的导入彻底改变了建立 App 的方式。函式响应式程式设计（Functional Reactive Programming，简称 FRP），近年来越来越流行，不过这是Apple 首次释出自己的函式响应式框架。在我看来，这是一个重要的典范转移（paradigm shift ）。Apple 公司最终对 FRP 做出定位，并推荐 Apple 开发者拥抱这个新的程式设计方法。 </p>
<p>就像导入任何一个新技术的导入一样，会有一个学习曲线，即使你之前有 iOS 开发经验，也要花一些时间从委派的程式设计方法变成到发布者/ 订阅者的设计方法。</p>
<p>不过，一旦你管理了 Combine 框架，你将会非常高兴，因为它可以帮你实现更可维护与模组化的代码，与SwiftUI 一起使用，如你所见，视图与视图模型之间的沟通变得轻而易举了。</p>
<p>在本章所准备的示例档中，有完整的项目可供下载： </p>
<ul>
<li>示例项目 (<a href="https://www.appcoda.com/resources/swiftui4/SwiftUIFormRegistration.zip" target="_blank">https://www.appcoda.com/resources/swiftui4/SwiftUIFormRegistration.zip</a>)</li>
</ul>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="./swiftui-form-data.html" class="navigation navigation-prev " aria-label="Previous page: 使用 Combine 与 Environment 物件进行数据分享"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="./swiftui-actionsheet-context.html" class="navigation navigation-next " aria-label="Next page: 滑动删除、内容选单与动作列表"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="gitbook/app.js"></script>

<script>
require(["gitbook"], function(gitbook) {
    var config = {"fontSettings":{"theme":"white","family":"serif","size":3},"image-captions":{"caption":"_CAPTION_","variable_name":"_pictures"}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
